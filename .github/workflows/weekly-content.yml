name: Weekly TikTok Content Generation with Approval

on:
  schedule:
    # Runs every Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch: # Manual trigger

jobs:
  generate-content:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GH_TOKEN }}
        fetch-depth: 0
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Install dependencies
      run: |
        pip install anthropic apify-client beautifulsoup4 requests pillow reportlab lxml elevenlabs
        
    - name: Scrape TikTok for trending content
      env:
        APIFY_API_KEY: ${{ secrets.APIFY_API_KEY }}
      run: |
        python scripts/scrape_tiktok.py
        
    - name: Generate new scripts and content
      env:
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      run: |
        python scripts/generate_content.py
        
    - name: Generate audio with ElevenLabs
      env:
        ELEVENLABS_API_KEY: ${{ secrets.ELEVENLABS_API_KEY }}
      run: |
        python scripts/generate_audio.py
        
    - name: Update dashboard HTML
      run: |
        python scripts/update_dashboard.py
        
    - name: Create Pull Request for Review
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GH_TOKEN }}
        commit-message: "ðŸ¤– Week $(date +%V) - New Career Content (REVIEW NEEDED)"
        branch: content-week-${{ github.run_number }}
        delete-branch: true
        title: "ðŸŽ¬ Week $(date +%V) Content - Review & Approve"
        body: |
          ## ðŸ¤– Automated Content Generation
          
          **Generated:** $(date)
          **Week:** $(date +%V)
          
          ### ðŸ“‹ New Content Created
          
          This PR includes:
          - 3 new day resources (PDFs)
          - Updated dashboard HTML
          - Audio files for all 3 days
          - TikTok trend analysis
          
          ### âœ… Review Checklist
          
          - [ ] Review Day scripts for quality
          - [ ] Check PDFs are properly formatted
          - [ ] Listen to audio files
          - [ ] Verify passwords are appropriate
          - [ ] Check HTML renders correctly
          - [ ] Approve content tone/style
          
          ### ðŸ“ Files Changed
          
          Check the "Files changed" tab to review:
          - New Day PDFs
          - Audio files (.mp3)
          - index.html updates
          - Content metadata (new_content.json)
          
          ### ðŸš€ To Publish
          
          1. Review all content above
          2. Make any edits directly in this branch if needed
          3. Click "Merge pull request" when ready
          4. Content will go live automatically!
          
          ### â¸ï¸ To Reject
          
          1. Close this PR without merging
          2. Content will be discarded
          3. Workflow will generate new content next week
        labels: content-review, automated
        
    - name: Create summary
      if: always()
      run: |
        echo "## ðŸŽ‰ Content Generated - Review Needed!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Status:** Pull Request Created" >> $GITHUB_STEP_SUMMARY
        echo "**Action Required:** Review and merge PR to publish" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“‹ Generated Content" >> $GITHUB_STEP_SUMMARY
        if [ -f new_content.json ]; then
          echo "âœ… 3 new resources created" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Audio files generated" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Dashboard updated" >> $GITHUB_STEP_SUMMARY
        fi
